<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/scheduler-component/scheduler-component.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">


<dom-module id="my-rooster">
  <template>
    <style>
      :host {
        display: block;
      }

      span {
        @apply --paper-font-body1;
      }

    </style>
    
        <paper-toast
      id="toast_invalid_aanroep"
      duration="0"
      text="U hebt dit scherm op een illegale manier geactiveerd. U wordt verwezen naar de home page!">
        <paper-button on-click="_toast_clicked" class="toast-button">Sluiten</paper-button>
    </paper-toast>
    
    <scheduler-component
          default-view="month"
          max-time="21:00:00" min-time="08:00:00"
          event-color="#003fff"
          text-color="#ecf0f1"
          events='[
             {"title" : "TICT-V1GP-18_2018","start" : "2019-04-01T16:00:00","end" : "2019-04-01T19:00:00","allDay" :false},
             {"title" : "TICT-V1GP-18_2018","start" : "2019-04-03T13:00:00","end" : "2019-04-03T16:00:00","allDay" :false},
             {"title" : "TICT-V1GP-18_2018","start" : "2019-04-05T13:00:00","end" : "2019-04-05T16:00:00","allDay" :false}]'
            header='{"center":"title","left":"prev,next,today","right":"month,agendaWeek,agendaDay"}'>
	</scheduler-component>
	
	<iron-ajax
      id="ajax_rooster_ophalen"
      method="POST"
      url="/rooster/ophalen"
      handle-as="json"
      on-response="_rooster_ophalen_response_handler">
	</iron-ajax>
	
	<iron-ajax
	  id="ajax_rooster_ophalen_docent"
	  method="POST"
	  url="/docent/rooster/ophalen"
	  handle-as="json"
	  on-response="_rooster_ophalen_docent_response_handler">
	</iron-ajax>

  </template>

  <script>
    (function() {
      'use strict';
      /* _xxxx private              : geen external data binding      - geen notify
         _c_xx private constant     : geen external binding, constant - geen notify
         c_xx  public constant      : one way external databinding [[c_xx]] - geen notify nodig
         xxxx  public               : two way external databinding {{xxxx}} - notify nodig
      */
      Polymer({
        is: 'my-rooster',

        properties: {
            _c_rooster: {
                type: Array,            		/* array<student-info>: student-info = {id, firstName, lastName, sameGroup} 
    												array is constant groepnr is changable */
              },
          c_username: {
            type: String,
          },
          c_rol: {
              type: String,
            },
          c_visible: {
              type: Boolean,                                      /* true when element is the active visible item */
              value: false,
              observer: '_initializing',                          /* wordt ook aangeroepen bijwisseling van true naar false.
                                                                     regel in de functie dat er niets gebeurd
                                                                     als c_visible false is */
            },
        },
        _go_home: function() {
            var lApp = document.querySelector('my-app');  //het polymer element <my-app>
            var lAppRouter = lApp.$.approuter;            // het html-element <app-route> met id=approuter
            lAppRouter.data={page: ""};                   // vul het data attribute met de homepage url
                                                          // door de two way binding in <app-route> en <app-location>
                                                          // zal ook de url echt wijzigen
          },
          
            _initializing : function() {
                if (this.c_visible) {                                 // zodra zichtbaar geworden moet er wat worden gedaan
                  if (this.c_rol=="student") {                        // voor studenten
                    this._rooster_ophalen_request_handler();    //    haal info op van server
                  } else {                                            // na handmatige url wijziging zonder login
                    this._rooster_ophalen_docent_request_handler();
                  }
                }
              },
         
            _rooster_ophalen_request_handler: function() {
                console.log("_rooster_ophalen_request_handler user="+this.c_username);
                this.$.ajax_rooster_ophalen.contentType="application/json";
                this.$.ajax_rooster_ophalen.body={
                  "naam":this.c_username
                };
                this.$.ajax_rooster_ophalen.generateRequest();
              },

              _rooster_ophalen_response_handler: function(request) {
                console.log("_rooster_ophalen_response_handler aantal lessen="+request.detail.response.length);
                console.log("_rooster_ophalen_response_handler lesse="+request.detail.response);
                this._c_rooster = request.detail.response;
              },
              
              _rooster_ophalen_docent_request_handler: function() {
                  console.log("_rooster_ophalen_docent_request_handler user="+this.c_username);
                  this.$.ajax_rooster_ophalen_docent.contentType="application/json";
                  this.$.ajax_rooster_ophalen_docent.body={
                    "naam":this.c_username
                  };
                  this.$.ajax_rooster_ophalen_docent.generateRequest();
                },

                _rooster_ophalen_docent_response_handler: function(request) {
                  console.log("_rooster_ophalen_docent_response_handler aantal lessen="+request.detail.response.length);
                  console.log("_rooster_ophalen_docent_response_handler lesse="+request.detail.response);
                  this._c_rooster = request.detail.response;
                },
              _toast_clicked: function(e) {
                  var lToast = this.$.toast_invalid_aanroep;        // meldt ongeldige aanroep
                  lToast.toggle();
                  this._go_home();
                 },
                 onError: function(e) {
                     // I think one of those two would be what you're looking for.
                     console.log(e.detail.response);
                     console.log(e.detail.request.xhr.response);
                   },
        
        
      });
    })();
  </script>
</dom-module>